<div v-cloak id="harvest-report">
    <h1 data-cy="page-header">Harvest Report</h1>
    <p>This page is a <i>mockup</i> of a simplified harvest report.</p>

    <label for=”title”>Title:</label>

    <input type="text" id="title" name="title"
    value="My Sample Harvest Report" v-model="reportTitle"/>
    <br><br>
    <label for="start"> Start: </label>
    <input v-model="startDate" data-cy="start-date"
        type="date"
        id="start"
        name="start"
        min="2014-01-01"
        :max="endDate"/>

    <label for="end"> End: </label>
    <input v-model="endDate" data-cy="end-date"
        type="date"
        id="end"
        name="end"
        :min="startDate"
        max="2022-01-01" />

    <br><br>

    <dropdown-with-all data-cy="crop-select"
        includes-all
        :selected-val="crop"
        :dropdown-list="cropNames"
        @selection-changed="cropChange">
        Crop:
    </dropdown-with-all>
    
    <label for="field"> Area: </label>
    <select id="field" name="field">
        <option v-for="area in areaNames"> {{area}} </option>
    </select>

    <br><br>
    <input type="button" value="Generate Report" @click="saveReport" data-cy="generate-report-button"/>

    <hr>

    <div v-if="farm!=''">
        <h1 data-cy="report-title"> {{reportTitle=="" ? "Mock Harvest Report" : reportTitle}} </h1>
        <p>Details:
            <ul>
                <li data-cy="farm-name"><b>Farm:</b>{{farm}}</li>
                <li data-cy="user-name"><b>User:</b>{{user}}</li>
                <li><b>Language:</b><span data-cy="language">{{ language }}</span></li>
                
                <br>
                <li><b>Start:</b>{{startDate}}</li>
                <li><b>End:</b>{{endDate}}</li>
                <li><b>Crop:</b>{{crop}}</li>
            </ul>
        </p>

        <custom-table data-cy="harvest-report-table"
            can-delete
            :columns="columns"
            :rows="harvestReportRows"
            @row-deleted="deleteTableRow"
            >
        </custom-table>
    </div>
</div>

<script>
    var vue = new Vue({
        el: "#harvest-report",
        created() {
            getIDToCropMap()
            .then((theMap) => {
                this.idToCropMap = theMap
            })
            .catch((err) => {
                console.log(err)
            })
            getIDToAreaMap()
            .then((theMap) => {
                this.idToAreaMap = theMap
            })
            .catch((err) => {
                console.log(err)
            })
        },
        
        components: {
            'dropdown-with-all': DropdownWithAllComponent,
            'custom-table': CustomTableComponent,
        },

        data: {
            farm: "",
            user: "",
            language: "",
            reportTitle: "My Sample Harvest Report",
            startDate: "2020-05-05",
            endDate: "2020-05-15",
            startTimestamp: 0,
            endTimestamp: 0,
            crop: "All",
            idToCropMap: new Map(),
            idToAreaMap: new Map(),
            harvestLogs: [],
            columns: [
                {"header": 'Row', "visible": true, "inputType": {'type': 'no input'}},
                {"header": 'Date', "visible": true, "inputType": {'type': 'no input'}},
                {"header": 'Area', "visible": true, "inputType": {'type': 'no input'}},
                {"header": 'Crop', "visible": true, "inputType": {'type': 'no input'}},
                {"header": 'Yield', "visible": true, "inputType": {'type': 'no input'}},
                {"header": 'Units', "visible": true, "inputType": {'type': 'no input'}},
            ],
            
        },
        computed: {
            cropNames() {
                return Array.from(this.idToCropMap.values())
            },
            areaNames() {
                return Array.from(this.idToAreaMap.values())
            },
            harvestReportRows() {
                let tableRows = []
                let row = 1
                for(let log of this.harvestLogs) {
                    let tableRow = {
                        id: log.id,
                        data: [
                            row,
                            dayjs.unix(log.timestamp).format("YYYY-MM-DD"),
                            log.area[0].name,
                            this.idToCropMap.get(log.data.crop_tid),
                            log.quantity[0].value,
                            log.quantity[0].unit.name,
                        ],
                    }
                    if (tableRow.data[3] == this.crop || this.crop == "All")
                    {
                        tableRows.push(tableRow)
                        row++
                    }
                }
                return tableRows
            },
        },
        methods: {
            saveReport: function() {
                axios.get('/farm.json')  // this line sends the request.
                .then((response) => {
                    this.farm = response.data.name
                    this.user = response.data.user.name
                    this.language = response.data.user.language
                })
                .catch((error) => {
                    console.log("Error Occurred")
                    console.log(error)
                })

                let startTimestamp = dayjs(this.startDate).unix()
                let endTimestamp = dayjs(this.endDate).unix()
                let request = "/log.json?type=farm_harvest&timestamp[ge]=" + startTimestamp + "&timestamp[le]=" + endTimestamp
                
                this.harvestLogs = []
                getAllPages(request, this.harvestLogs)
                .then(() => {
                })
                .catch((err) => {
                    console.log(err)
                })
            },
            deleteTableRow: function(rowIDs) {
                for(let i = 0; i < rowIDs.length; i++){
                    for(var j = 0; j < this.harvestReportRows.length; j++){
                        if(this.harvestReportRows[j].id == rowIDs[i]){
                            this.harvestLogs.splice(j, 1)
                        }
                    }
                }
            },
            cropChange(newCrop) {
                this.crop = newCrop
            },
        }
        
    })

    Vue.config.devtools = true;
</script>