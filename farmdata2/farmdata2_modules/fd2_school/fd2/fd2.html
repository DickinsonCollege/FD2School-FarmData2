<div id="harvest-report" v-cloak>
        <h1 data-cy="page-header">Harvest Report</h1>
        <p>This page is a <i>mockup</i> of a simplified harvest report.</p>

        <label for="title">Title:</label>
        <input type="text" id="title" name="title" v-model="reportTitle"/><br />

	<dropdown-with-all data-cy="crop-selection" includes-all :selected-val='reportCrop' :dropdown-list='cropNames' @selection-changed='cropChanged'> Crop: </dropdown-with-all><br />

        <label for="field">Field:</label>
        <select id="field" name="field">
                <option v-for="area in areaNames">{{area }}</option>
        </select><br />

        <label for="start">Start date:</label>
        <input type="date" id="start" name="start-date" value="2020-05-05" min="2014-01-01" :max="reportEndDate" v-model="reportStartDate" data-cy="start-date"/>

        <label for="end">End date:</label>
        <input type="date" id="end" name="end-date" value="2020-05-15" :min="reportStartDate" max="2022-01-01" v-model="reportEndDate" data-cy="end-date"/><br />

        <button class="btn btn-primary" @click='generateReport()' type="button" data-cy="generate-report-button">Generate Report</button>

        <hr />

        <h1 data-cy="report-title">{{ reportTitle ? reportTitle : "Mock Harvest Report" }}</h1>
        <p>Details:</p>
        <ul>
                <li data-cy="farm-name"><strong>Farm: </strong>{{ reportFarm }}</li>
                <li data-cy="user-name"><strong>User: </strong>{{ reportUser }}</li>
                <li><strong>Language: </strong><span data-cy="user-lang">{{ reportLanguage }}</span></li><br />
                <li><strong>Start: </strong>{{ reportStartDate }}</li>
                <li><strong>End: </strong>{{ reportEndDate }}</li>
                <li><strong>Crop: </strong>{{ reportCrop }}</li><br />
        </ul>



	<custom-table data-cy="report-table"
            can-edit
            can-delete
            csv-name="UI_example_"
            :columns="columns"
            :rows="newHarvestReportRows"
	    v-if="newHarvestReportRows.length!=0"
            >
        </custom-table>
	<p v-else>No matching logs found.</p>



</div>
<script>
        var harvestReport = new Vue({
                el: "#harvest-report",
                data: {
                        reportTitle: "My Sample Harvest Report",
			reportFarm: "",
			reportUser: "",
			reportLanguage: "",
                        reportStartDate: "2020-05-05",
			reportEndDate: "2020-05-15",
			reportCrop: "All",
			areas: ["All", "Chuau-1", "SQ7",],
			idToCropMap: new Map(),
                        idToAreaMap: new Map(),
			requestedHarvestLogs: [],
			columns: [
				{"header": 'Date', "visible": true, "inputType": {'type': 'no input'}},
				{"header": 'Area', "visible": true, "inputType": {'type': 'no input'}},
                                {"header": 'Crop', "visible": true, "inputType": {'type': 'no input'}},
                                {"header": 'Yield', "visible": true, "inputType": {'type': 'no input'}},
                                {"header": 'Units', "visible": true, "inputType": {'type': 'no input'}},

			],

		},
		computed: {
			cropNames() {
				return Array.from(this.idToCropMap.values());
			},
			areaNames() {
                                return Array.from(this.idToAreaMap.values());
                        },


			newHarvestReportRows() {
				let newTableRows = []
                                for(let log of this.requestedHarvestLogs) {

                                        if (this.reportCrop == this.idToCropMap.get(log.data.crop_tid) || this.reportCrop == "All") {
                                                let tableRow = {
							id: log.id,
							data: [
	                                                        dayjs.unix(log.timestamp).format('MM/DD/YYYY'),
	                                                        log.area[0].name,
	                                                        log.quantity[0].value,
	                                                        log.quantity[0].unit.name,
	                                                        this.idToCropMap.get(log.data.crop_tid),
                                                	]
						}
                                                newTableRows.push(tableRow)
                                        }
                                }
                                return newTableRows

			}

		},


		methods: {
			cropChanged(newCrop) {
				this.reportCrop = newCrop
			},
			generateReport: function() {
				axios.get('/farm.json')
				.then((response) => {
        			this.reportFarm = response.data.name;
                                this.reportUser = response.data.user.name;
                                this.reportLanguage = response.data.languages.en.name;
				})
				.catch((error) => {
				console.log("Error Occured");
                                console.log(error);
				})
				
				let startTimestamp = dayjs(this.reportStartDate).unix();	
                                let endTimestamp = dayjs(this.reportEndDate).unix();
				let logRequest = "/log.json?type=farm_harvest&timestamp[ge]=" + startTimestamp + "&timestamp[le]=" + endTimestamp
				this.requestedHarvestLogs = [],				
				getAllPages(logRequest, this.requestedHarvestLogs)
				.then(() => {
				})
				.catch((err) => {
				console.log("Error Occured");
				console.log(error);
				})



			},
		},

		created() {
			getIDToCropMap()
			.then((theCropMap) => {
    			this.idToCropMap = theCropMap;
			})
			.catch((err) => {
			console.long("Error: failed to fetch ID to Crop Map");
			})

			getIDToAreaMap()
                        .then((theAreaMap) => {
                        this.idToAreaMap = theAreaMap;
                        })
                        .catch((err) => {
                        console.long("Error: failed to fetch ID to Area Map");
                        })



		},

		components: {
			'dropdown-with-all': DropdownWithAllComponent,
		        'custom-table': CustomTableComponent,

		},



        });
	Vue.config.devtools = true;
</script>
