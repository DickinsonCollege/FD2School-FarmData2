<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <script src="https://unpkg.com/dayjs@1.11.10/dayjs.min.js"></script>
  </head>
  <body>
    <div id="report" v-cloak>
      <h1 data-cy="page-header">Harvest Report</h1>
      <p>This page is a <i>mockup</i> of a simplified harvest report.</p>
      <label for="title">Title: </label>
        <input type="text" id="title" name="title" placeholder="My Sample Harvest Report" v-model="header">
      <br></br>
      <label for="start"><strong>Start:</strong></label>
      <input data-cy="start-date" type="date" id="start" name="start" v-model="startDate" min="01/01/2014" :max="endDate" />
      <label for="start"><strong>End:</strong></label>
      <input data-cy="end-date" type="date" id="end" name="end" v-model="endDate" :min="startDate" max="01/01/2022" />
      <br></br>
      <label for="crop"><strong>Crop:</strong></label>
      <dropdown-with-all 
            data-cy="crop-dropdown"
            includes-all
            :selected-val="selectedCrop"
            :dropdown-list="cropNames"
            @selection-changed="cropChanged">
        </dropdown-with-all>
      <label for="field"><strong>Area:</strong></label>
              <select id="field" name="field">
                  <option v-for="area in areas">{{ area }}</option>
              </select>
      <br></br>
      <button data-cy="generate-report-button" type="button" @click='addHarvest'>Generate Report</button>
      <hr></hr>
      <h1 data-cy="report-title">{{ header ? header : 'Mock Harvest Report'}}</h1>
  
    <p>Details</p>
    <ul>
        <li data-cy="farm" v-model="farm"><strong>Farm:</strong>{{farm}}</li>
        <li data-cy="user" v-model="user"><strong>User:</strong>{{user}}</li>
        <li data-cy="language" v-model="language"><strong>Language:</strong>{{language}}</li>
        <br/>
        <li><strong>Start:</strong>{{startDate}}</li>
        <li><strong>End:</strong>{{endDate}}</li>
        <li><strong>Crop:</strong>{{selectedCrop}}</li>
    </ul>
    <div v-if="harvestReportRows.length > 0">
    <table border="1">
        <tr>
          <td><strong>Row</strong></td>
          <td><strong>Date</strong></td>
          <td><strong>Area</strong></td>
          <td><strong>Crop</strong></td>
          <td><strong>Yield</strong></td>
          <td><strong>Units</strong></td>

        </tr>

        <tr v-for="(t,index) in harvestReportRows">
          <td>{{ index + 1}}</td>
          <td>{{ t.date }}</td>
          <td>{{ t.area }}</td>
          <td> {{ t.crop }}</td>
          <td>{{ t.yield }}</td>
          <td>{{ t.units }}</td>
        </tr>
      </table>
    </div>
    </div>
      <script>
        var reportTitle = new Vue({
          el: '#report',
          components: {
            'dropdown-with-all': DropdownWithAllComponent
          },
          created() {
            console.log("HarvestReport Vue instance created!")
            getIDToCropMap()
            .then((theMap) => {
                this.idToCropMap = theMap;
                console.log(this.idToCropMap);
            })
            .catch((err) => {
                console.log(err);
            })
          },
          data: {
            harvestLogs: [],
            idToCropMap: new Map(),
            farm: "",
            user: "",
            language: "",
            header: 'My Sample Harvest Report',
            startDate: '2020-05-05', 
            endDate: '2020-05-15', 
            selectedCrop: 'All',
            areas: [
              'All',
              'Chuau-1',
              'SQ7',
            ],
            harvestList: []
          },
          computed: {
            cropNames() {
              return Array.from(this.idToCropMap.values())
            },
            harvestReportRows() {
                let tableRows = []
                for(let log of this.harvestLogs) {
                    if (this.selectedCrop == this.idToCropMap.get(log.data.crop_tid)) {
                        let tableRow = {
                            date: dayjs.unix(log.timestamp).format('YYYY-MM-DD'),
                            area: log.area[0].name,
                            yield: log.quantity[0].value,
                            units: log.quantity[0].unit.name,
                            crop: this.idToCropMap.get(log.data.crop_tid),
                        }
                
                    tableRows.push(tableRow)
                }
            }
                return tableRows
            }
          },
          methods: {
            cropChanged(newCrop) {
                this.selectedCrop = newCrop;
            },
            addHarvest: function() {
              let startTimestamp = dayjs(this.startDate).unix();
              let endTimestamp = dayjs(this.endDate).unix();

              let requestString = `/log.json?type=farm_harvest&timestamp[ge]=${startTimestamp}&timestamp[le]=${endTimestamp}`;
              getAllPages(requestString, this.harvestLogs)
                .then(() => {
                    console.log("Harvest logs: ", this.harvestLogs);
                })
                .catch((err) => {
                    console.log(err);
                })
              axios.get('/farm.json')  
              .then((response) => {
                this.farm = response.data.name;
                this.user = response.data.user.name;
                this.language = response.data.languages.en.name;
              })
              .catch((error) => {
                console.log(error)
              })
            }
          }
        })
        Vue.config.devtools = true;
      </script>
  </body>
</html>